---
import { Image, getImage } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import type { MarkdownHeading } from "astro";
import CodeCopyButton from "@/components/post/CodeCopyButton/CodeCopyButton.astro";
import Comments from "@/components/post/Comments/Comments.astro";
import FormattedDate from "@/components/ui/FormattedDate/FormattedDate.astro";
import Tag from "@/components/ui/Tag/Tag.astro";
import PageLayout from "./PageLayout.astro";

type Props = CollectionEntry<"blog">["data"] & {
  headings?: MarkdownHeading[];
  relatedPosts?: CollectionEntry<"blog">[];
  showComments?: boolean;
};

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  tags,
  headings = [],
  relatedPosts = [],
  showComments = true,
} = Astro.props;
const showToc = headings.length >= 2;
const displayedRelatedPosts = relatedPosts.slice(0, 4);
const optimizedHero = heroImage ? await getImage({ src: heroImage, width: 1920 }) : null;
---

<PageLayout
  title={title}
  description={description}
  image={heroImage}
  size="full"
>
  <article>
    {heroImage && optimizedHero ? (
      <div
        class="mb-8 -mt-12 -mx-6 sm:-mx-6 xl:-mt-12 xl:-mx-25.5 min-h-[50vh] bg-cover bg-center relative"
        style={`background-image: url(${optimizedHero.src});`}
      >
        <header class="absolute bottom-0 left-0 right-0 backdrop-blur-md bg-black/40 p-6 xl:p-8">
          <h1 class="text-md md:text-5xl m-0 mb-4 text-white">{title}</h1>
          <div class="flex items-center gap-4 text-sm text-gray-300 mb-4">
            <FormattedDate date={pubDate} />
            {updatedDate && (
              <span class="italic">
                Updated <FormattedDate date={updatedDate} />
              </span>
            )}
          </div>
          {tags && tags.length > 0 && (
            <div class="flex gap-2 flex-wrap">
              {tags.map((t) => <Tag tag={t} />)}
            </div>
          )}
        </header>
      </div>
    ) : (
      <header class="mb-8 pb-8 border-b border-gray-light">
        <h1 class="text-md md:text-5xl m-0 mb-4">{title}</h1>
        <div class="flex items-center gap-4 text-sm text-gray mb-4">
          <FormattedDate date={pubDate} />
          {updatedDate && (
            <span class="italic">
              Updated <FormattedDate date={updatedDate} />
            </span>
          )}
        </div>
        {tags && tags.length > 0 && (
          <div class="flex gap-2 flex-wrap">
            {tags.map((t) => <Tag tag={t} />)}
          </div>
        )}
      </header>
    )}

    <div
      class:list={["flex gap-12 items-start", { "justify-center": !showToc }]}
    >
      <!-- Main Content -->
      <div
        class:list={["min-w-0 max-w-[920px]", showToc ? "flex-1" : "w-full"]}
      >

        <!-- Article Content -->
        <div class="prose">
          <slot />
        </div>
      </div>

      <!-- Sidebar (TOC only) -->
      {
        showToc && (
          <aside class="hidden lg:block w-[240px] shrink-0 sticky top-28">
            <div class="max-h-[calc(100vh-4rem)] overflow-y-auto">
              <h3 class="text-sm m-0 mb-4 text-gray uppercase tracking-wider">
                Table of Contents
              </h3>
              <ul class="list-none m-0 p-0 space-y-1">
                {headings.map((heading) => (
                  <li>
                    <a
                      href={`#${heading.slug}`}
                      class:list={[
                        "block no-underline hover:text-accent transition-colors",
                        heading.depth === 2
                          ? "text-gray-dark"
                          : "text-sm text-gray pl-3",
                      ]}
                    >
                      {heading.text}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </aside>
        )
      }
    </div>

    <!-- Related Posts -->
    {
      displayedRelatedPosts.length > 0 && (
        <section class="mt-12 pt-8 border-t border-gray-light">
          <h2 class="text-2xl text-center lg:text-left">Related Posts</h2>
          <div class="grid mt-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {displayedRelatedPosts.map((post) => (
              <a href={`/blog/${post.id}/`} class="group block no-underline">
                {post.data.heroImage && (
                  <Image
                    width={300}
                    height={170}
                    src={post.data.heroImage}
                    alt=""
                    class="rounded-lg mb-3 mx-auto group-hover:shadow-md transition-shadow aspect-video object-cover"
                  />
                )}
                <div class="text-base max-w-[300px] mx-auto text-center px-4 lg:px-0 lg:text-left text-gray-dark group-hover:text-accent transition-colors line-clamp-2">
                  {post.data.title}
                </div>
              </a>
            ))}
          </div>
        </section>
      )
    }

    {showComments && <Comments />}
  </article>

  <CodeCopyButton />
</PageLayout>
