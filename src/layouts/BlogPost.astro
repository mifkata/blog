---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import type { MarkdownHeading } from "astro";
import BaseHead from "../components/BaseHead.astro";
import Comments from "../components/Comments.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Header from "../components/Header.astro";
import Tag from "../components/Tag.astro";

type Props = CollectionEntry<"blog">["data"] & {
  headings?: MarkdownHeading[];
  relatedPosts?: CollectionEntry<"blog">[];
  showComments?: boolean;
};

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  tags,
  headings = [],
  relatedPosts = [],
  showComments = true,
} = Astro.props;
const showToc = headings.length >= 2;
const displayedRelatedPosts = relatedPosts.slice(0, 4);
---

<html lang="en">
  <head>
    <BaseHead title={title} description={description} image={heroImage} />
  </head>

  <body>
    <div class="content-wrapper">
      <Header />
      <main class="w-full max-w-[960px] mx-auto px-6 py-12">
        <article>
          <!-- Hero Image -->
          {
            heroImage && (
              <div class="mb-8">
                <Image
                  width={1200}
                  height={600}
                  src={heroImage}
                  alt=""
                  class="w-full rounded-xl shadow-lg"
                />
              </div>
            )
          }

          <div
            class:list={[
              "flex gap-12 items-start",
              { "justify-center": !showToc },
            ]}
          >
            <!-- Main Content -->
            <div
              class:list={[
                "min-w-0 max-w-[720px]",
                showToc ? "flex-1" : "w-full",
              ]}
            >
              <!-- Article Header -->
              <header class="mb-8 pb-8 border-b border-gray-light">
                <h1 class="text-4xl md:text-5xl m-0 mb-4">{title}</h1>
                <div class="flex items-center gap-4 text-sm text-gray mb-4">
                  <FormattedDate date={pubDate} />
                  {
                    updatedDate && (
                      <span class="italic">
                        Updated <FormattedDate date={updatedDate} />
                      </span>
                    )
                  }
                </div>
                {
                  tags && tags.length > 0 && (
                    <div class="flex gap-2 flex-wrap">
                      {tags.map((t) => (
                        <Tag tag={t} />
                      ))}
                    </div>
                  )
                }
              </header>

              <!-- Article Content -->
              <div class="prose prose-lg">
                <slot />
              </div>
            </div>

            <!-- Sidebar (TOC only) -->
            {
              showToc && (
                <aside class="hidden lg:block w-[240px] shrink-0 sticky top-28">
                  <div class="max-h-[calc(100vh-4rem)] overflow-y-auto">
                    <h3 class="text-sm m-0 mb-4 text-gray uppercase tracking-wider">
                      Table of Contents
                    </h3>
                    <ul class="list-none m-0 p-0 space-y-1">
                      {headings.map((heading) => (
                        <li>
                          <a
                            href={`#${heading.slug}`}
                            class:list={[
                              "block no-underline hover:text-accent transition-colors",
                              heading.depth === 2
                                ? "text-gray-dark"
                                : "text-sm text-gray pl-3",
                            ]}
                          >
                            {heading.text}
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                </aside>
              )
            }
          </div>

          <!-- Related Posts -->
          {
            displayedRelatedPosts.length > 0 && (
              <section class="mt-12 pt-8 border-t border-gray-light">
                <h2 class="text-2xl m-0 mb-6">Related Posts</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                  {displayedRelatedPosts.map((post) => (
                    <a
                      href={`/blog/${post.id}/`}
                      class="group block no-underline"
                    >
                      {post.data.heroImage && (
                        <Image
                          width={300}
                          height={170}
                          src={post.data.heroImage}
                          alt=""
                          class="rounded-lg mb-3 group-hover:shadow-md transition-shadow aspect-video object-cover"
                        />
                      )}
                      <span class="text-base text-gray-dark group-hover:text-accent transition-colors line-clamp-2">
                        {post.data.title}
                      </span>
                    </a>
                  ))}
                </div>
              </section>
            )
          }

          {showComments && <Comments />}
        </article>
      </main>
      <Footer />
    </div>
  </body>
</html>
