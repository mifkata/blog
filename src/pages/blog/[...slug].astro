---
import { type CollectionEntry, getCollection, render } from "astro:content";
import BlogPost from "@/layouts/BlogPost.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post, allPosts: posts },
  }));
}

interface Props {
  post: CollectionEntry<"blog">;
  allPosts: CollectionEntry<"blog">[];
}

const { post, allPosts } = Astro.props;
const { Content, headings } = await render(post);
const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);

// Get related posts based on matching tags
const currentTags = post.data.tags || [];
const relatedPosts = allPosts
  .filter((p) => p.id !== post.id)
  .map((p) => {
    const matchingTags = (p.data.tags || []).filter((tag) =>
      currentTags.includes(tag),
    );
    return { post: p, matchCount: matchingTags.length };
  })
  .filter((p) => p.matchCount > 0)
  .sort((a, b) => b.matchCount - a.matchCount)
  .slice(0, 3)
  .map((p) => p.post);
---

<BlogPost {...post.data} headings={tocHeadings} relatedPosts={relatedPosts}>
  <Content />
</BlogPost>
