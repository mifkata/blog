---
import { Image } from "astro:assets";

interface Props {
  src: ImageMetadata;
  alt: string;
  width?: number;
}

const { src, alt, width = 1280 } = Astro.props;
---

<figure class="labeled-image my-6 p-0">
  <Image
    {src}
    {alt}
    {width}
    class="clickable block mx-auto rounded-lg cursor-zoom-in"
  />
  <figcaption
    class="text-center text-sm text-gray mt-2 italic [&_a]:text-accent"
  >
    <slot />
  </figcaption>
</figure>

<div class="modal hidden fixed inset-0 z-[1000]" aria-hidden="true">
  <div class="modal-backdrop absolute inset-0 bg-black/90"></div>
  <div
    class="modal-content relative p-[3%] w-full h-full flex items-center justify-center box-border"
  >
    <Image
      src={src}
      alt={alt}
      width={src.width}
      height={src.height}
      quality="max"
      class="max-w-full max-h-full object-contain rounded-lg"
    />
  </div>
</div>

<script>
  function setupImageModals() {
    document
      .querySelectorAll<HTMLElement>(".labeled-image")
      .forEach((figure) => {
        const img = figure.querySelector<HTMLImageElement>("img.clickable");
        const modal = figure.nextElementSibling as HTMLElement;
        if (!img || !modal?.classList.contains("modal")) return;

        const backdrop = modal.querySelector<HTMLElement>(".modal-backdrop");
        const modalContent = modal.querySelector<HTMLElement>(".modal-content");

        img.addEventListener("click", () => {
          modal.classList.remove("hidden");
          modal.classList.add("flex", "items-center", "justify-center");
          modal.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
        });

        const closeModal = () => {
          modal.classList.add("hidden");
          modal.classList.remove("flex", "items-center", "justify-center");
          modal.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
        };

        backdrop?.addEventListener("click", closeModal);
        modalContent?.addEventListener("click", (e) => {
          if (e.target === modalContent) closeModal();
        });

        modal.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });

        modal.addEventListener("click", (e) => {
          if (e.target === modal) closeModal();
        });
      });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document
          .querySelectorAll<HTMLElement>(".modal:not(.hidden)")
          .forEach((modal) => {
            modal.classList.add("hidden");
            modal.classList.remove("flex", "items-center", "justify-center");
            modal.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";
          });
      }
    });
  }

  setupImageModals();
  document.addEventListener("astro:page-load", setupImageModals);
</script>
