---
import { getSeriesWithPosts } from "@/helpers/series";
import { Image } from "astro:assets";
import Synopsis from "@/components/post/Synopsis/Synopsis.astro";

interface Props {
  slug: string;
}

const { slug } = Astro.props;
const series = await getSeriesWithPosts(slug);
const gridCols = Math.min(series.items.length, 4);
---

<section class="max-w-[960px] mx-auto pb-12">
  <div class="flex flex-col mb-4">
    <h3 class="text-lg text-gray tracking-wider uppercase text-nowrap">
      Featured Series:
    </h3>
    <h4 class="text-lg m-0 text-gray tracking-wider">
      {series.title}
    </h4>
    <div class="flex-1 h-px bg-gray-light"></div>
  </div>

  <!-- Grid -->
  <div
    class:list={[
      "flex flex-col md:grid gap-4 overflow-visible relative",
      gridCols === 1 ? "md:grid-cols-1 min-h-128" : 
      gridCols === 2 ? "md:grid-cols-2" : 
      gridCols === 3 ? "md:grid-cols-3" :
      "md:grid-cols-4",
    ]}
    id="series-grid"
  >
    {
      series.items.map((item, index) => (
        <button
          type="button"
          class={`
            series-item w-full h-auto md:h-42 p-0
            bg-white border border-gray-light rounded-lg
            hover:border-accent hover:shadow-lg
            transition-all text-left cursor-pointer
            group
          `}
          data-index={index}
          data-url={item.url}
          data-title={item.title}
          data-synopsis={item.data?.synopsis || ""}
          data-date={
            item.data?.updatedDate?.toISOString() ||
            item.data?.pubDate?.toISOString() ||
            ""
          }
        >
          {item.data?.heroImage && (
            <Image
              src={item.data.heroImage}
              alt={item.title}
              class="series-image z-[100] hidden md:block w-full min-h-32 rounded-t-lg transition ease-out duration-220"
            />
          )}
          <a
            href={item.url}
            class="rounded-b-lg w-full p-4 pb-2 hover:underline hidden group-[.active]:md:block"
            title="Go to artic-2"
          >
            <h4 class="m-0 z-[10] line-clamp-2">{item.title}</h4>
          </a>

          <div class="relative p-4 rounded-b-lg w-full block md:hidden">
            <div
              class={`
                  absolute top-0 bottom-0 left-0 w-[0]
                  right-0 group-[.active]:w-[100%]
                  transition-w delay-0 duration-180 ease-out
                  mix-blend-exclusion
                  bg-[teal]/30
                  z-[5]
                `}
            />
            <h4 class="m-0 z-[10]">{item.title}</h4>
          </div>
        </button>
      ))
    }
  </div>

  <!-- Active article details -->
  <div
    id="series-details"
    class="mt-6 p-6 bg-white border border-gray-light rounded-lg"
  >
    {
      series.items.map((item, index) => (
        <div
          class="series-synopsis hidden mb-3 leading-relaxed md:columns-2 gap-6"
          data-index={index}
        >
          {item.data?.heroImage && (
            <Image
              src={item.data.heroImage}
              alt={item.title}
              class="block md:hidden w-full rounded-t-lg mb-4"
            />
          )}
          <Synopsis text={item.data?.synopsis} />
        </div>
      ))
    }
    <div class="md:flex items-center justify-between">
      <p id="series-date" class="text-gray m-0 text-sm"></p>
      <a
        id="series-read-more"
        href="#"
        class="text-accent hover:text-accent-dark font-medium no-underline text-nowrap"
      >
        Read more â†’
      </a>
    </div>
  </div>
</section>

<style>
  .series-item {
    transition:
      transform 0.5s ease,
      border-color 0.3s,
      box-shadow 0.3s;
    transform-origin: top center;
    overflow: hidden;
    align-self: center;
    transition: ease-in 0.3s;
  }
  .series-item.active {
    border-color: var(--accent);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    transform: scale(1.15);
    z-index: 10;
    position: relative;
    height: auto;
  }
  .series-image {
    object-fit: cover;
    transform: scale(3);
  }
  .series-item.active .series-image {
    object-fit: cover;
    transform: scale(1);
  }
</style>

<script>
  const ROTATE_INTERVAL = 3000;

  function initGrid() {
    const grid = document.getElementById("series-grid");
    const items = grid?.querySelectorAll(
      ".series-item",
    ) as NodeListOf<HTMLElement>;
    const synopsisEls = document.querySelectorAll(
      ".series-synopsis",
    ) as NodeListOf<HTMLElement>;
    const dateEl = document.getElementById("series-date");
    const readMoreEl = document.getElementById(
      "series-read-more",
    ) as HTMLAnchorElement;

    if (!grid || !items.length || !synopsisEls.length || !dateEl || !readMoreEl)
      return;

    let currentIndex = 0;
    let intervalId: number;

    function selectItem(index: number) {
      items.forEach((item, i) => {
        item.classList.toggle("active", i === index);
      });

      synopsisEls.forEach((el) => {
        el.classList.toggle("hidden", el.dataset.index !== String(index));
      });

      const item = items[index];
      const url = item.dataset.url || "#";
      readMoreEl!.href = url;

      const dateStr = item.dataset.date;
      if (dateStr) {
        const date = new Date(dateStr);
        dateEl!.textContent = `Last updated: ${date.toLocaleDateString(
          "en-US",
          {
            year: "numeric",
            month: "long",
            day: "numeric",
          },
        )}`;
      }

      currentIndex = index;
    }

    function nextItem() {
      const next = (currentIndex + 1) % items.length;
      selectItem(next);
    }

    items.forEach((item, index) => {
      item.addEventListener("click", () => {
        clearInterval(intervalId);
        selectItem(index);
      });
    });

    // Initial selection (random) + start auto-rotate
    selectItem(currentIndex);
    intervalId = window.setInterval(nextItem, ROTATE_INTERVAL);
  }

  document.addEventListener("DOMContentLoaded", initGrid);
  document.addEventListener("astro:page-load", initGrid);
</script>
